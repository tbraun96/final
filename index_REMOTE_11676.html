<!DOCTYPE html>
<html lang="en">

<head>
    <title>Geovisual Analytics| LIDAR Exploration</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="please add">
    <link rel="shortcut icon" type="image/png" href="/favicon.png"/>
    <!-- CSS Base -->
    <link rel="stylesheet" type='text/css' media='all' href="css/webslides.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.14/c3.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="all" href="css/style.css">
    <!-- Javascript Library -->
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="js/webslides.min.js"></script>
    <script src="https://unpkg.com/d3@5/dist/d3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.14/c3.min.js"></script>


    <link rel="stylesheet" type="text/css" href="build/potree/potree.css">
    <link rel="stylesheet" type="text/css" href="libs/jquery-ui/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="libs/perfect-scrollbar/css/perfect-scrollbar.css">
    <link rel="stylesheet" type="text/css" href="libs/openlayers3/ol.css">
    <link rel="stylesheet" type="text/css" href="libs/spectrum/spectrum.css">
    <link rel="stylesheet" type="text/css" href="libs/jstree/themes/mixed/style.css">
    <link rel="stylesheet" href="https://cesiumjs.org/releases/1.57/Build/Cesium/Widgets/widgets.css"></head>

    <style>
        #myVideo {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
        }
    </style>
    <!--Google Font-->
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web&display=swap" rel="stylesheet">
</head>

<body>

<script src="libs/jquery/jquery-3.1.1.min.js"></script>
<script src="libs/spectrum/spectrum.js"></script>
<script src="libs/perfect-scrollbar/js/perfect-scrollbar.jquery.js"></script>
<script src="libs/jquery-ui/jquery-ui.min.js"></script>
<script src="libs/three.js/build/three.min.js"></script>
<script src="libs/other/BinaryHeap.js"></script>
<script src="libs/tween/tween.min.js"></script>
<script src="libs/d3/d3.js"></script>
<script src="libs/proj4/proj4.js"></script>
<script src="libs/openlayers3/ol.js"></script>
<script src="libs/i18next/i18next.js"></script>
<script src="libs/jstree/jstree.js"></script>
<script src="build/potree/potree.js"></script>
<script src="libs/plasio/js/laslaz.js"></script>
<script src="https://cesiumjs.org/releases/1.57/Build/Cesium/Cesium.js"></script>

<article id="webslides">
    <section class="bg-white">
        <video id="myVideo" src = "assets/view01.mp4" autoplay muted>
            <script>
                var myvid = document.getElementById('myVideo');

                var myvids = [
                    "assets/view01.mp4",
                    "assets/view02.mp4"
                ];
                var activeVideo = 0;
                myvid.playbackRate = 1.5;
                myvid.addEventListener('ended', function(e) {
                    // update the new active video index
                    activeVideo = (++activeVideo) % myvids.length;

                    // update the video source and play
                    myvid.src = myvids[activeVideo];
                    myvid.play();
                });
            </script>
        </video>
        <div style="font-family: 'Titillium Web', sans-serif; border;
color: #1a2028;
-webkit-box-shadow: 10px 10px 41px 0px rgba(0,0,0,0.7);
-moz-box-shadow: 10px 10px 41px 0px rgba(0,0,0,0.7);
box-shadow: 10px 10px 41px 0px rgba(0,0,0,0.7);
<<<<<<< HEAD
text-align: center;
background-color: rgba(255,255,255, 0.7);" class="wrap aligncenter">
            <h2>
                <strong> Web Visualizing a LiDAR Point Cloud of a Stand in the McDonald-Dunn Forest</strong>
            </h2>
            <div style="z-index: 999; text-align: center">
            <h3>
              <strong>Corvallis, OR, USA</strong>
            </h3>
          </div>
        </div>

        <div style = "z-index: 999; border: 2px black; background-color: rgba(255,255,255, 0.7); position: absolute; top: 0; left: 0; width: 100%; max-height: 250px; min-height: 150px; height: 13%;">
        <img src="assets/carto.png" style = "position: absolute; left:0; top: 0%; max-height: 150px; max-width: 25%; margin-top: 1%;">
        <img src="assets/osu2.png" style = "position: absolute; right:0; top: 0; max-height: 170px; max-width: 25%; margin-top: -0.5%;">
        </div>

    </section>
    <!-- the first map -->
    <section class="bg-apple">

        <div id="potree" class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">

            <div style="font-family: 'Titillium Web', sans-serif; align-content: center; padding-bottom: 30px; padding-top: 10px;
color: #1a2028;
-webkit-box-shadow: 21px 21px 60px 0px rgba(0,0,0,0.7);
-moz-box-shadow: 21px 21px 60px 0px rgba(0,0,0,0.7);
box-shadow: 21px 21px 60px 0px rgba(0,0,0,0.7);
text-align: center;
z-index: 999;
width:55%;
top: 2%; background-color: rgba(255,255,255, 0.7);" class="wrap aligncenter">
                <h1>
                    <p class = "text-subtitle">Area of Interest</p>
                </h1>
                </h2>
                    <p class = "text-subtitle">McDonald-Dunn Forest, Corvallis, OR, USA</p>
                </h2>
            </div>

            <div id="potree_render_area">
                <div id="cesiumContainer" style="position: absolute; width: 100%; height: 100%; background-color:transparent"></div>
            </div>
            <div id="potree_sidebar_container"> </div>
        </div>

        <script>
            function load_sys(){
                window.cesiumViewer = new Cesium.Viewer('cesiumContainer', {
                    useDefaultRenderLoop: false,
                    animation: false,
                    vrButton: false,
                    baseLayerPicker : false,
                    fullscreenButton: false,
                    terrainProvider : Cesium.createWorldTerrain(),
                    geocoder: false,
                    homeButton: false,
                    infoBox: false,
                    sceneModePicker: false,
                    selectionIndicator: false,
                    timeline: false,
                    navigationHelpButton: false,
                    terrainShadows: Cesium.ShadowMode.DISABLED,
                });




                let cp = new Cesium.Cartesian3(4303414.154026048, 552161.235598733, 4660771.704035539);
                cesiumViewer.camera.setView({
                    destination : cp,
                    orientation: {
                        heading : 10,
                        pitch : -Cesium.Math.PI_OVER_TWO * 0.5,
                        roll : 0.0
                    }
                });

                window.potreeViewer = new Potree.Viewer(document.getElementById("potree_render_area"), {
                    useDefaultRenderLoop: false
                });
                potreeViewer.setEDLEnabled(true);
                potreeViewer.setFOV(40);
                potreeViewer.setPointBudget(1000*1000);
                potreeViewer.setMinNodeSize(0);
                potreeViewer.loadSettingsFromURL();
                potreeViewer.setBackground(null);

                potreeViewer.loadGUI(() => {
                    potreeViewer.setLanguage('en');
                    $("#menu_appearance").next().show();
                    //viewer.toggleSidebar();
                });


                Potree.loadPointCloud("pointclouds/saddleback/cloud.js", "saddleback.sa", e => {
                    potreeViewer.scene.addPointCloud(e.pointcloud);
                    e.pointcloud.position.z = 170;
                    let material = e.pointcloud.material;
                    material.pointColorType = Potree.PointColorType.ELEVATION; // any Potree.PointColorType.XXXX
                    material.pointSizeType = Potree.PointSizeType.ATTENUATED;
                    material.shape = Potree.PointShape.CIRCLE;
                    material.elevationRange =[170,350]

                    potreeViewer.scene.view.position.set(476828.47,  4943195.899999999, 2067.402);
                    potreeViewer.scene.view.lookAt(new THREE.Vector3(476828.47,  4942195.899999999, -0.707));

                    Potree.measureTimings = true;


                    let pointcloudProjection = e.pointcloud.projection;
                    let mapProjection = proj4.defs("WGS84");

                    window.toMap = proj4(pointcloudProjection, mapProjection);
                    window.toScene = proj4(mapProjection, pointcloudProjection);

                    {
                        let bb = potreeViewer.getBoundingBox();

                        let minWGS84 = proj4(pointcloudProjection, mapProjection, bb.min.toArray());
                        let maxWGS84 = proj4(pointcloudProjection, mapProjection, bb.max.toArray());
                    }
                });

                function loop(timestamp){
                    requestAnimationFrame(loop);

                    potreeViewer.update(potreeViewer.clock.getDelta(), timestamp);

                    potreeViewer.render();

                    potreeViewer.scene.getActiveCamera().addEventListener(
                        function() {
                            if (potreeViewer.scene.getActiveCamera()._suspendTerrainAdjustment && potreeViewer.scene.getActiveCamera().scene.mode === Cesium.SceneMode.SCENE3D) {
                                potreeViewer.scene.getActiveCamera()._suspendTerrainAdjustment = false;
                                potreeViewer.scene.getActiveCamera()._adjustHeightForTerrain();
                            }
                        }
                    );

                    if(window.toMap !== undefined){

                        {
                            let camera = potreeViewer.scene.getActiveCamera();

                            let pPos		= new THREE.Vector3(0, 0, 0).applyMatrix4(camera.matrixWorld);
                            let pRight  = new THREE.Vector3(600, 0, 0).applyMatrix4(camera.matrixWorld);
                            let pUp		 = new THREE.Vector3(0, 600, 0).applyMatrix4(camera.matrixWorld);
                            let pTarget = potreeViewer.scene.view.getPivot();

                            let toCes = (pos) => {
                                let xy = [pos.x, pos.y];
                                let height = pos.z;
                                let deg = toMap.forward(xy);
                                let cPos = Cesium.Cartesian3.fromDegrees(...deg, height);

                                return cPos;
                            };

                            let cPos = toCes(pPos);
                            let cUpTarget = toCes(pUp);
                            let cTarget = toCes(pTarget);

                            let cDir = Cesium.Cartesian3.subtract(cTarget, cPos, new Cesium.Cartesian3());
                            let cUp = Cesium.Cartesian3.subtract(cUpTarget, cPos, new Cesium.Cartesian3());

                            cDir = Cesium.Cartesian3.normalize(cDir, new Cesium.Cartesian3());
                            cUp = Cesium.Cartesian3.normalize(cUp, new Cesium.Cartesian3());

                            cesiumViewer.camera.setView({
                                destination : cPos,
                                orientation : {
                                    direction : cDir,
                                    up : cUp
                                }
                            });

                        }

                        let aspect = potreeViewer.scene.getActiveCamera().aspect;
                        if(aspect < 1){
                            let fovy = Math.PI * (potreeViewer.scene.getActiveCamera().fov / 180);
                            cesiumViewer.camera.frustum.fov = fovy;
                        }else{
                            let fovy = Math.PI * (potreeViewer.scene.getActiveCamera().fov / 180);
                            let fovx = Math.atan(Math.tan(0.5 * fovy) * aspect) * 2
                            cesiumViewer.camera.frustum.fov = fovx;
                        }

                    }

                    cesiumViewer.render();
                }

                requestAnimationFrame(loop);
            }
        </script>

    </section>

    <!-- the second map -->
    <section class="slideInRight">

        <div id="mymap2">
            <div style="font-family: 'Titillium Web', sans-serif; padding-bottom: 30px; padding-top: 10px;
color: #1a2028;
-webkit-box-shadow: 21px 21px 60px 0px rgba(0,0,0,0.7);
-moz-box-shadow: 21px 21px 60px 0px rgba(0,0,0,0.7);
box-shadow: 21px 21px 60px 0px rgba(0,0,0,0.7);
text-align: center;
z-index: 999;
top: 2%; background-color: rgba(255,255,255, 0.7);" class="wrap aligncenter">
                <h1>
                    <p class = "text-subtitle">About the Geovisualization</p>
                </h1>
            </div>
        </div>
<<<<<<< HEAD
        <div id="info" style="position: absolute; left:0; bottom: 0; height: 50%; width:60%; max-width:800px; color: #1a2028;
-webkit-box-shadow: 21px 21px 60px 0px rgba(0,0,0,0.7);
-moz-box-shadow: 21px 21px 60px 0px rgba(0,0,0,0.7);
box-shadow: 21px 21px 60px 0px rgba(0,0,0,0.7);
text-align: center; background-color: rgba(255,255,255, 0.7);">
                <h1>
                    <p class = "text-subtitle" style = "font:Sans-Serif"><br><br><br></p>
        <div id="info" style="position: absolute; left:0; bottom: 0; height: 50%; width:60%; max-width:800px;color: black;">

            Saddleback stand was visualized using LiDAR point clouds from 2008. The Saddleback stand is located north of Corvallis in the McDonald-Dunn Forest and is visible from town.
            The stand was previously thinned in 1999. Agencies project a future timber harvest in the Saddleback stand.
            Forest aesthetics, or the visual appeal of the Saddleback stand when viewed from Corvallis, will be a variable dictating the harvest treatment in the stand. Foresters must designate a harvest treatemnt for Saddleback that will create optimal forest aesthetics.
            Active forest management relies on social license, or the common public acceptance of target management practicies. If society does not accept forest managment practices near Corvallis because of the negative impacts to forest aesthetics, social license may be lost.
            Therefore, pre-harvest models simulating maximized post-harvest forest aesthetics in highly visible stands are an important tool for foresters to maintain social license. These models are created through geospatial and statistical analyses of 3D point cloud data.
            Through the Saddleback geovisualization, we created a web platform for viewing models simulating maximized forest aesthetics. The Saddleback visualization displays a baseline pre-harvest forest stand model. This template is adaptable for visualizing pre-harvest models simulating post-harvest conditions.

                    <p class = "text-info">more text here!</p>
                </h1>
        </div>
    </section>

    <section class="slide-top bg-trans-dark" style="font-family: 'Titillium Web', sans-serif;">

        <center><h2><strong>Credits</strong></h2></center><br><br>

        <ul class="flexblock border" >
            <li>
                <strong><u>Video</u></strong><br>Drone footage captured by Katharine Nicolato, Bryan Begay, and Thomas Braun
            </li>
            <li>
                <strong><u>Favicon</u></strong><br>Obtained via IconFinder
            </li>
            <li>
                <strong><u>Javascript Libraries</u></strong><br>D3.js, Cesium, Leaflet.js
            </li>
            <li>
                <strong><u>LIDAR Data</u></strong><br> DOGAMI
            </li>
            <li>
                <strong><u>LIDAR computation</u></strong><br>Potree Converter
            </li>
            <li>
                <strong><u>HTML/JS/CSS Visual Libs</u></strong></br>https://webslides.tv/
            </li>
            <li>
                <strong><u>Google Fonts</u></strong></br>https://fonts.googleapis.com/css?family=Playfair+Display&display=swap
            </li>
        </ul>

        <div style = "border: 2px black; background-color: rgba(255,255,255, 0.7); position: absolute; bottom: 0; left: 0; width: 100%; max-height: 270px; min-height: 150px; height: 15%;">
        <img src="assets/carto.png" style = "position: absolute; left:0; bottom: 0; max-height: 150px; min-height: 150px; max-width: 25%;">
        <img src="assets/osu2.png" style = "position: absolute; right:0; bottom: 0; max-height: 180px; min-height: 150px; max-width: 25%;">
        </div>

    </section>

</article>

<script>
    // make the web slide object.
    var ws = new WebSlides();


    //44.636940, -123.292661
    var maxBounds = [
        [44.636940, -123.292661],
        [44.636938, -123.292659]
    ];

    //var bounds = L.latLngBounds(maxBounds);

    //Map2

    var map2 = L.map("mymap2", {
        zoomControl: true,
        scrollWheelZoom: true
    }).setView([44.636940, -123.292661], 13);


    //map2.fitBounds(bounds);

    //d3.select("#mymap2").data(data1);


    // add a basemap for the second map
    L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map2);

    var marker = L.marker([44.636940, -123.292661], { title: "Forest" }).addTo(map2);


    var potree_loaded = false;
    if (window.location.href.includes("&doReload=1")){
        console.log("Detected doReload=1");
        load_sys();
        potree_loaded = true;
    }
    // bind a function to the slide change event of web slides
    ws.el.addEventListener('ws:slide-change', function () {

        // capture all the div under the currently displaying section
        crtDiv = $(".current div");
        console.log("DIV: " + crtDiv.attr("id"));
        //Map 1 'flyto' animation location and function
         if (crtDiv.attr("id") === "mymap2") {
            // Checks if the map container size changed and updates the map if so
            map2.invalidateSize();
            //Fly to a new location.
            map2.flyTo([44.636940, -123.292661], 12, {
                animate: true,
                duration: 4
            });
        } else if (crtDiv.attr("id") === "potree"){
             console.log("HERE");
             if (!potree_loaded){
                 load_sys();
                 potree_loaded = true;
             } else {
                 var newUrl = window.location.href + "&doReload=1";
                 console.log("Resetting location to " + newUrl);
                 location.href = newUrl;
                 location.reload(true);
             }
         }

    });
</script>
</body>

</html>
